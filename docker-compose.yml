version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: henkes-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-henkes}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-stoffzauber2025}
      MONGO_INITDB_DATABASE: henkes-stoffzauber
    volumes:
      - mongodb_data:/data/db
      - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - henkes-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API Server (Node.js)
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: henkes-api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3001
      MONGODB_URI: mongodb://${MONGO_USER:-henkes}:${MONGO_PASSWORD:-stoffzauber2025}@mongodb:27017/henkes-stoffzauber?authSource=admin
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: 7d
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-info@henkes-stoffzauber.de}
      FRONTEND_URL: https://henkes-stoffzauber.de
      ALLOWED_ORIGINS: https://henkes-stoffzauber.de,https://www.henkes-stoffzauber.de
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SHOP_EMAIL: ${SHOP_EMAIL:-info@henkes-stoffzauber.de}
      PAYPAL_ENV: ${PAYPAL_ENV:-sandbox}
      PAYPAL_CLIENT_ID: ${PAYPAL_CLIENT_ID}
      PAYPAL_CLIENT_SECRET: ${PAYPAL_CLIENT_SECRET}
    volumes:
      - uploads_data:/app/uploads
      - invoices_data:/app/invoices
      - api_logs:/app/logs
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - henkes-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend (Nginx serving static build)
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: henkes-web
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - henkes-network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: henkes-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - uploads_data:/var/www/uploads:ro
      - invoices_data:/var/www/invoices:ro
      - certbot_www:/var/www/certbot:ro
      - certbot_conf:/etc/letsencrypt:ro
    depends_on:
      - api
      - web
    networks:
      - henkes-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 60s
      timeout: 5s
      retries: 3

  # Certbot for SSL (Let's Encrypt)
  certbot:
    image: certbot/certbot
    container_name: henkes-certbot
    volumes:
      - certbot_www:/var/www/certbot:rw
      - certbot_conf:/etc/letsencrypt:rw
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - henkes-network

volumes:
  mongodb_data:
    name: henkes-mongodb-data
  uploads_data:
    name: henkes-uploads
  invoices_data:
    name: henkes-invoices
  api_logs:
    name: henkes-api-logs
  certbot_www:
    name: henkes-certbot-www
  certbot_conf:
    name: henkes-certbot-conf

networks:
  henkes-network:
    name: henkes-network
    driver: bridge
